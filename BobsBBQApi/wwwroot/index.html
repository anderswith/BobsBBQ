<!DOCTYPE html>
<html lang="da">
<head>
    <title>Bob's BBQ</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="FrontPageStyle.css">
</head>
<body>

<header>
    <div class="logo">Bob's BBQ</div>
    <nav id="nav-buttons">
        <!-- Knapper genereres via JS -->
    </nav>
</header>

<div class="hero">
    Velkommen til Bob's BBQ
</div>

<div class="indhold">

    <div class="grid1">
        <img class="infoIMG" src="OmOS.png" alt="">
    </div>
    <div class="grid2">
        <img class="bbq" src="billede1.jpg" alt="">
        <img class="bbq" src="billede2.jpg" alt="">
        <img class="bbq" src="billede3.jpg" alt="">
    </div>
    <div class="grid3">
        <img class="infoIMG" src="BBQMenu.png" alt="Menukort">
    </div>
</div>
dotnet 
<div class="Footer">
    
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
    <div class="modal-content">
        <span id="closeLoginModal" class="close">&times;</span>
        <form id="loginForm">
            <div class="input-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div class="button-group">
                <button type="submit" id="loginBtn">Login</button>
            </div>
        </form>
    </div>
</div>

<!-- Sign Up Modal -->
<div id="signupModal" class="modal">
    <div class="modal-content">
        <span id="closeSignupModal" class="close">&times;</span>
        <h2>Sign Up</h2>
        <form id="signupForm">
            <div class="input-group">
                <label for="signupName">Navn</label>
                <input type="text" id="signupName" name="name" required>
            </div>
            <div class="input-group">
                <label for="signupEmail">Email</label>
                <input type="email" id="signupEmail" name="email" required>
            </div>
            <div class="input-group">
                <label for="signupPhone">Telefon</label>
                <input type="tel" id="signupPhone" name="phone" required>
            </div>
            <div class="input-group">
                <label for="signupPassword">Password</label>
                <input type="password" id="signupPassword" name="password" required>
            </div>
            <div class="input-group">
                <label for="signupRole">Role</label>
                <select id="signupRole" name="role" required>
                    <option value="">Select a role</option>
                    <option value="Admin">Admin</option>
                    <option value="Customer">Customer</option>
                </select>
            </div>

            <div class="button-group">
                <button type="submit">Opret Konto</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reservationModalLabel">Bestil Bord</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Luk"></button>
            </div>
            <div class="modal-body">
                <form id="reservationForm">
                    <div class="mb-3">
                        <label for="reservationDate" class="form-label">Dato</label>
                        <input type="date" class="form-control" id="reservationDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="reservationGuests" class="form-label">Antal gæster</label>
                        <input type="number" class="form-control" id="reservationGuests" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="reservationTime" class="form-label">Tidspunkt</label>
                        <select class="form-select" id="reservationTime" required>
                            <option value="">Vælg et tidspunkt</option>
                            <!-- Tider indsættes dynamisk -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reservationNote" class="form-label">Besked (valgfri)</label>
                        <textarea class="form-control" id="reservationNote" rows="2" placeholder="Skriv evt. en besked..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary" id="submitReservationBtn">Send reservation</button>
            </div>
        </div>
    </div>
</div>


<script>
    const loginModal = document.getElementById('loginModal');
    const signupModal = document.getElementById('signupModal');
    const closeLoginModal = document.getElementById('closeLoginModal');
    const closeSignupModal = document.getElementById('closeSignupModal');
    const editButton = document.getElementById('edit-button');
    const paragraph = document.getElementById('about-paragraph');
    const editor = document.getElementById('about-editor');
    const nav = document.getElementById('nav-buttons');

    // Modal handling
    window.addEventListener('click', (event) => {
        if (event.target === loginModal) loginModal.style.display = 'none';
        if (event.target === signupModal) signupModal.style.display = 'none';
    });

    if (closeLoginModal) {
        closeLoginModal.addEventListener('click', () => loginModal.style.display = 'none');
    }
    if (closeSignupModal) {
        closeSignupModal.addEventListener('click', () => signupModal.style.display = 'none');
    }

    // Hent brugerrolle fra API
    async function fetchUserRole() {
        const token = localStorage.getItem('jwtToken');
        if (!token) return '';
        try {
            const res = await fetch('https://din-api-url.com/brugerinformatioon', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) throw new Error('Brugerinfo fejl');
            const data = await res.json();
            return data.UserRole || '';
        } catch (err) {
            console.error(err);
            return '';
        }
    }

    // Opsæt navbar
    async function setupNavbar() {
        const token = localStorage.getItem('jwtToken');
        const role = await fetchUserRole();

        nav.innerHTML = '';
        if (editButton) editButton.style.display = 'none';

        if (!token || role === '') {
            nav.innerHTML = `
                <button id="loginBtnOpen">Login</button>
                <button id="signupBtnOpen">Sign Up</button>`;

            console.log("buttons added");

            const loginBtnOpen = document.getElementById("loginBtnOpen");
            const signupBtnOpen = document.getElementById("signupBtnOpen");

            if (signupBtnOpen && signupModal && closeSignupModal) {
                signupBtnOpen.onclick = () => {
                    signupModal.style.display = 'block';
                };

                closeSignupModal.onclick = () => {
                    signupModal.style.display = 'none';
                };

                window.addEventListener('click', (event) => {
                    if (event.target === signupModal) {
                        signupModal.style.display = 'none';
                    }
                });
            }

            if (loginBtnOpen && loginModal) {
                loginBtnOpen.onclick = () => {
                    loginModal.style.display = 'block';
                };
            }

        } else if (role === 'Customer') {
            nav.innerHTML = `
                <button id="bestilBtn">Bestil Bord</button>
                <button id="logoutBtn">Log Ud</button>`;

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.onclick = logout;

        } else if (role === 'Admin') {
            nav.innerHTML = `
                <a href="OpretBord.html"><button>Opret Bord</button></a>
                <button id="logoutBtn">Log Ud</button>`;

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.onclick = logout;

            if (editButton) editButton.style.display = 'inline-block';
        }
    }

    // Signup form
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('signupName').value;
        const email = document.getElementById('signupEmail').value;
        const phone = document.getElementById('signupPhone').value;
        const password = document.getElementById('signupPassword').value;
        const role = document.getElementById('signupRole').value;

        try {
            const res = await fetch('http://localhost:5251/RegisterUser', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userName: name,
                    email: email,
                    phoneNumber: phone,
                    password: password,
                    userRole: role
                })
            });
            if (!res.ok) throw new Error('Signup fejlede');
            signupModal.style.display = 'none';
            alert('Bruger oprettet. Du kan nu logge ind.');
        } catch (err) {
            alert('Oprettelse fejlede – prøv igen.');
            console.error(err);
        }
    });

    // Login form
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const res = await fetch('http://localhost:5251/LoginUser', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            if (!res.ok) throw new Error('Login fejlede');
            const data = await res.json();
            localStorage.setItem('jwtToken', data.token);
            loginModal.style.display = 'none';
            await setupNavbar();
        } catch (err) {
            alert('Login mislykkedes – prøv igen.');
            console.error(err);
        }
    });

    // Redigér knap
    if (editButton) {
        editButton.addEventListener('click', () => {
            if (editor.style.display === 'none') {
                editor.value = paragraph.textContent.trim();
                paragraph.style.display = 'none';
                editor.style.display = 'block';
                editButton.textContent = 'Gem';
            } else {
                paragraph.textContent = editor.value;
                editor.style.display = 'none';
                paragraph.style.display = 'block';
                editButton.textContent = 'Redigér tekst';
            }
        });
    }

    // Log ud
    function logout() {
        localStorage.removeItem('jwtToken');
        location.reload();
    }

    // Kør navbar setup ved indlæsning
    window.onload = () => {
        setupNavbar();
    };

    // Reservation setup
    document.addEventListener("DOMContentLoaded", function () {
        const reservationDate = document.getElementById("reservationDate");
        const reservationGuests = document.getElementById("reservationGuests");
        const reservationTime = document.getElementById("reservationTime");
        const reservationNote = document.getElementById("reservationNote");
        const submitReservationBtn = document.getElementById("submitReservationBtn");

        async function fetchAvailableTimes(date, guests) {
            try {
                const response = await fetch(`http://localhost:5000/api/reservation/times?date=${date}&people=${guests}`);
                const data = await response.json();

                reservationTime.innerHTML = `<option value="">Vælg et tidspunkt</option>`;
                data.forEach(time => {
                    const option = document.createElement("option");
                    option.value = time;
                    option.textContent = time;
                    reservationTime.appendChild(option);
                });
            } catch (error) {
                console.error("Fejl ved hentning af tider:", error);
            }
        }

        [reservationDate, reservationGuests].forEach(el =>
            el.addEventListener("change", () => {
                const date = reservationDate.value;
                const guests = reservationGuests.value;
                if (date && guests) {
                    fetchAvailableTimes(date, guests);
                }
            })
        );

        submitReservationBtn.addEventListener("click", async () => {
            const date = reservationDate.value;
            const guests = parseInt(reservationGuests.value);
            const time = reservationTime.value;
            const note = reservationNote.value;
            const userId = localStorage.getItem("userId");

            if (!date || !guests || !time) {
                alert("Udfyld venligst alle påkrævede felter.");
                return;
            }

            const reservationData = {
                reservationDate: date,
                timeSlot: time,
                partySize: guests,
                note: note,
                userId: userId
            };

            try {
                const response = await fetch("http://localhost:5000/api/reservation", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(reservationData)
                });

                if (response.ok) {
                    alert("Reservation sendt!");
                    bootstrap.Modal.getInstance(document.getElementById("reservationModal")).hide();
                    document.getElementById("reservationForm").reset();
                    reservationTime.innerHTML = `<option value="">Vælg et tidspunkt</option>`;
                } else {
                    const err = await response.text();
                    alert("Fejl ved reservation: " + err);
                }
            } catch (error) {
                console.error("Fejl:", error);
                alert("Noget gik galt. Prøv igen senere.");
            }
        });
    });
</script>


</body>
</html>
